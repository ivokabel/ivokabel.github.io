---
layout: post
title: "Rendering Layered Materials: Weidlich-Wilkie Layered Model"
comments: true
---

This is a chapter of the blog post series [Rendering Layered Materials](rendering-layered-materials.html).

Here I present a (not that) brief explanation of the [original layered model](https://www.cg.tuwien.ac.at/research/publications/2007/weidlich_2007_almfs/) by Andrea Weidlich and Alexander Wilkie, published in 2007 at the Graphite conference (predecessor of the SIGGRAPH Asia conference).

They assume that layers are micro-facet-based models and there is homogeneous attenuating medium between the layers. The ideally smooth Fresnel model can be used for outer layer too, since it can be thought of as a special case of a micro-facet model. Additionally a diffuse Lambert model can be used for the bottom layer since we only need to compute the reflection component without any special micro-facet-related assumptions on it.

To avoid evaluation of complex sub-surface light scattering, they proposed an approximation based on these 4 simplifications:

- **Thin layers:** Micro-facets are considered to be much larger in horizontal extent, than the layers are thick.
- **Single-point sampling:** Rays which are generated by sampling the inner BSDF layer are assumed to exit at the original point of incidence.
- **Single-point refractions:** Refraction rays that are generated for the computation of the entire BSDF, are assumed to meet at a single point on the next layer interface.
- **Non-scattering medium:** All light scattering is due to reflection at the boundaries between layers; no scattering occurs within individual layers.

The simplification 1 allows them to assume that an incident ray of light will leave through the same micro-facet through which it entered the surface, thus simplifying both evaluation and sampling. The simplifications 2 and 3 cause, along with easier evaluation and sampling, that the resulting model stays a “single-point” scattering function (BSDF) instead of extending it to an “areal” sub-surface scattering function (BSSDF), which would be necessary if we wanted to do a full light transport simulation. The simplification 4 simply forbids volumetric scattering within the medium, which would make the whole task much more complicated.

In a modern realistic renderer, a BSDF needs to handle two tasks: evaluation and sampling. Let’s see how the Weidlich-Wilkie model addresses them.

## Evaluation

<p style="text-align: center">
   <img src="../images/Weidlich-Wilkie - Layers - Evaluation.svg" alt="BSDF evaluation process" width="360" /><br/>
   Layered BSDF evaluation process. Image reused from the Weidlich-Wilkie paper.
</p>

1. The BSDF of the outer layer $f_{r1}$ is evaluated for the two given, arbitrary incoming directions $\omega_{i}$ and $\omega_{o}$. This yields a reflection component and two refraction directions $\omega_{i^{\prime}} $ and $\omega_{o^{\prime}}$.
2. The light which is refracted below the outer layer (transmission coefficient $T_{12}$) follows the two refraction directions associated with the initial incident directions, and is attenuated by the medium (attenuation coefficient $a$).
3. These two refraction directions are assumed to meet at a single point on the inner layer $f_{r2}$.
4. On returning from the inner layer, the individual BSDF components are attenuated by the Fresnel transmission coefficients $T_{21}$ for the outer layer, and added to the total BSDF.

The total BSDF is then

$$
f_{r}=f_{r1}\left(\theta_{i},\theta_{o}\right)+T_{21} \cdot f_{r2}\left(\theta_{i^{\prime}},\theta_{o^{\prime}}\right)\cdot a\cdot t
$$

where $a$ represents the medium attenuation (modeled with the [Beer-Lambert-Bouguer law](https://en.wikipedia.org/wiki/Beer%E2%80%93Lambert_law))

$$
a=e^{-\alpha\left(d\cdot\left(\frac{1}{\cos\theta_{i^{\prime}}}+\frac{1}{\cos\theta_{o^{\prime}}}\right)\right)}
$$

where $\alpha$ is the medium attenuation coefficient, $d$ is the thickness of the layer, $\theta_{i^{\prime}}$ and $\theta_{o^{\prime}}$ are inclinations of the respective refraction directions, and

$$
t=\left(1-G\right)+T_{21}\cdot G
$$

where $G$ is the geometric attenuation term of the micro-facet model used. The authors didn't bother to explain whether it is the geometric term of the outer or the inner layer, but it, most likely, is the outer one.

### My notes

First, there is no explanation of the $t$ component at all! The inner layer reflection component looks like this after expansion of $t$:

$$
T_{12} \cdot f_{r2}\left(\theta_{i^{\prime}},\theta_{o^{\prime}}\right)\cdot a \cdot \left(\left(1-G\right)+T_{21}\cdot G\right)
$$

It seems to me that this is their ad-hoc (and incorrect) attempt to evaluate the light transmission through micro-facet-based surface, which was properly solved and published just in the same year (2007) by Walter et al. in the paper [Microfacet Models for Refraction through Rough Surfaces](https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.html), and probably also an energy compensation term.

Second, it is important to understand that the model tries to approximate the whole sub-surface light transport by evaluating just one path. Moreover, it also neglects the multiple scattering nature of the light transport within the layers. This basically cuts the energy which is reflected (partially or completely in case of total internal reflection) from the inner layer and then from the the outer layer back into the medium between the two layers. They try to compensate the missing energy by "energy compensation term" which, again, is not explained at all in the paper.

An interesting property of their single-path approximation is (and the paper doesn’t explain this clearly enough) that they use the micro-facet’s normal for computing the refracted directions. This may cause approximation imprecisions when the normal approaches grazing angles.

Last, but not least, the paper completely ignores effects of solid angle (de-)compression which happens when the light crosses the boundaries between media with different indices of refraction.

## Sampling

<p style="text-align: center">
   <img src="../images/Weidlich-Wilkie - Layers - Assumptions - Base.svg" alt="BSDF evaluation process" width="700" /><br/>
   Sampling configuration. Image reused from the Weidlich-Wilkie paper.
</p>

When a ray hits a surface, a micro-facet normal for the outer model is generated. The sampling of the whole BSDF then resembles a light propagation simulation -- light would be partially reflected and partially refracted according to the Fresnel equation, which defines two paths to follow. One of the paths is chosen randomly.

For the reflection path, we only reflect the incident direction from the micro-facet and we are done. For the refraction path, we have to refract the incident direction through the micro-facet and use it to sample a reflection direction of the inner layer. The direction has to be refracted back through the micro-facet of the outer layer to the outside world.

### PDF

The paper doesn't properly explain how to compute the resulting PDF when sampling the BSDF, but we can assume that it is consistent with the computations done when the whole BSDF is evaluated. In that case, the PDF is computed as a weighted sum of the individual PDFs $p_i$ of both layers with some arbitrarily chosen constant weights $w_i$:

$$
p=w_{1}p_{1} + w_{2}p_{2}
$$

### My notes

I find the sampling process of the paper problematic. It basically randomly picks one of the layers according to probabilities equal to constants $w_i$ and uses its PDF to generate the resulting direction. Since the sampling strategy should be as much proportional to the whole BSDF as possible to get good importance sampling, we need to weight the individual sampling PDFs with the actual contributions of the respective BSDF components (layers). Therefore, using constant weights hardly leads to an optimal sampling strategy since it completely ignores both the Fresnel attenuation and the attenuation within the medium which are both direction dependent.

The second problem with the sampling arises from the fact that the probability density of the direction generated by the inner BSDF changes when undergoing refraction operation at the outer layer. This leads to inconsistency between the computed and the actual PDF, which subsequently leads to a biased Monte-Carlo estimator in the renderer.
