---
layout: post
title: A Journey to the World of Layered Surface Materials, Chapter 1
comments: false
---

I decided to implement some kind of multi-layered material model (BSDF) in my pet renderer since they offer much more expressivity than basic models (e.g. smooth Fresnel, glossy micro-facet models, or diffuse Lambert) and I also wanted to learn some more advanced rendering-related tech.

In the beginning I wanted to just directly implement the paper [Arbitrarily Layered Micro-Facet Surfaces](https://www.cg.tuwien.ac.at/research/publications/2007/weidlich_2007_almfs/) by Andrea Weidlich and Alexander Wilkie. However, it turned out that the paper is too ad-hoc to my standards and their justifications too vague or even non-existent, so I decided to come up with my own approach, which is heavily inspired by the ideas from the paper.

I decided to restrict the model to just two layers (1 -- outer and 2 -- inner). This decision simplifies both theory and implementation a bit while still having the rich expressivity of a layered model. In my following explanation I ignore the fact that there can be more than two layers even in the original Weidlich-Wilkie paper.

## Weidlich-Wilkie Layered Model

Let’s start with a (not that) brief introduction of the original model by Andrea Weidlich and Alexander Wilkie, published in 2007 at the Graphite conference (predecessor of the SIGGRAPH Asia conference).

They assume that layers are micro-facet-based models and there is homogeneous attenuating medium between the layers. The ideally smooth Fresnel model can be used for outer layer too, since it can be thought of as a special case of a micro-facet model. Additionally a diffuse Lambert model can be used for the bottom layer since we only need to compute the reflection component without any special micro-facet-related assumptions on it.

To avoid evaluation of complex sub-surface light scattering, they proposed an approximation based on these 4 simplifications:

* Micro-facets are considered to be much larger in horizontal extent, than the layers are thick.
* Rays which are generated by sampling the inner BSDF layer are assumed to exit at the original point of incidence.
* Refraction rays that are generated for the computation of the entire BSDF, are assumed to meet at a single point on the next layer interface.
* All light scattering is due to reflection at the boundaries between layers; no scattering occurs within individual layers.

The simplification 1 allows them to assume that an incident ray of light will leave through the same micro-facet through wich it entered the surface, thus simplifying both evaluation and sampling. The simplifications 2 and 3 cause, along with easier evaluation and sampling, that the resulting model stays a “single-point” scattering function (BSDF) instead extendending to an “areal” sub-surface scattering function (BSSDF), which would be necessary if we wanted to do a full light transport simulation. The simplification 4 simply forbids volumetric scattering within the medium, which would make the whole task much more complicated.

In a modern renderer, a BSDF needs to handle two tasks: evaluation and sampling. Let’s see how the Weidlich-Wilkie model addresses them.

### Evaluation

<p style="text-align: center">
   <img src="../../../images/Weidlich-Wilkie - Layers - Evaluation.svg" alt="BSDF evaluation process" /><br/>
   Layered BSDF evaluation process. Image reused from the Weidlich-Wilkie paper.
</p>

* The BSDF of the outer layer $f_{r1}$ is evaluated for the two given, arbitrary incoming directions $\omega_{i}$ and $\omega_{o}$. This yields a reflection component and two refraction directions $\omega_{i^{\prime}} $ and $\omega_{o^{\prime}}$.
* The light which is refracted below the outer layer (transmission coefficient $T_{12}$) follows the two refraction directions associated with the initial incident directions, and is attenuated by the medium (attenuation coefficient $a$).
* These two refraction directions are assumed to meet at a single point on the inner layer $f_{r2}$.
* On returning from the inner layer, the individual BSDF components are attenuated by the Fresnel transmission coefficients $T_{21}$ for the outer layer, and added to the total BSDF.

$$
f_{r}=f_{r1}\left(\theta_{i},\theta_{o}\right)+T_{21} \cdot f_{r2}\left(\theta_{i^{\prime}},\theta_{o^{\prime}}\right)\cdot a\cdot t
$$

where $a$ represents the medium attenuation (Bouguer-Lambert-Beer law)

$$
a=e^{-\alpha\left(d\cdot\left(\frac{1}{\cos\theta{i^{\prime}}}+\frac{1}{\cos\theta{o^{\prime}}}\right)\right)}
$$

where $d$ is the thickness of the layer, and

$$
t=\left(1-G\right)+T_{21}\cdot G
$$

where $G$ is the geometric attenuation term of the micro-facet model used. The authors didn't bother to explain whether it is the geometric term of the outer or the inner layer, but it, most likely, is the outer one.

#### My notes

First, there is no explanation of the $t$ component at all! The inner layer reflection component looks like this after expansion of $t$:

$$
T_{12} \cdot f_{r2}\left(\theta_{i^{\prime}},\theta_{o^{\prime}}\right)\cdot a \cdot \left(\left(1-G\right)+T_{21}\cdot G\right)
$$

It seems to me that this is their ad-hoc (and incorrect) attempt to evaluate the light transmission through micro-facet-based surface, which was properly solved and published just in the same year (2007) by Walter et al. in the paper [Microfacet Models for Refraction through Rough Surfaces](https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.html).

Second, it is important to understand that the model tries to approximate the whole sub-surface light transport by evaluating just one path while also neglecting the multiple scattering nature of the process. An interesting property of this approximation is (and the paper doesn’t explain this clearly enough) that they use the micro-facet’s normal for computing the refracted directions. This may cause approximation imprecisions for the incoming directions $\omega_{i}$ and $\omega_{o}$ at grazing angles.

Last, but not least, it completely ignores effect of solid angle (de-)compression when the light crosses the boundaries between media with different indices of refraction.

### Sampling

TODO… 
